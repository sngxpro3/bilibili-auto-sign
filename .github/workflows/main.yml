name: Bilibili Daily Auto Sign

on:
  schedule:
    - cron: '0 16 * * *'  # UTC16ç‚¹=åŒ—äº¬æ—¶é—´0ç‚¹
  workflow_dispatch:

jobs:
  bilibili-sign-job:
    runs-on: ubuntu-latest
    steps:
      - name: Set Timezone to Beijing
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "âœ… æ—¶åŒºå·²è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´ï¼Œå½“å‰æ—¶é—´ï¼š$(date)"

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          pip install requests pytz -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: Run Bilibili Sign Script
        id: sign_step
        env:
          BILIBILI_COOKIE: ${{ secrets.BILIBILI_COOKIE }}
        run: |
          cat > bilibili_sign.py << 'EOF'
          import requests
          import os
          import logging
          from datetime import datetime
          import pytz

          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s - %(levelname)s - %(message)s',
              datefmt='%Y-%m-%d %H:%M:%S',
              handlers=[logging.StreamHandler()]
          )

          # è·å–åŒ—äº¬æ—¶é—´
          beijing_tz = pytz.timezone('Asia/Shanghai')
          beijing_time = datetime.now(beijing_tz).strftime('%Y-%m-%d %H:%M:%S')

          # è¯»å–Cookie
          cookie = os.getenv('BILIBILI_COOKIE')
          if not cookie:
              logging.error("âŒ æœªè·å–åˆ°Bç«™Cookieï¼è¯·æ£€æŸ¥GitHub Secretsé…ç½®")
              exit(1)

          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Cookie': cookie,
              'Referer': 'https://www.bilibili.com/',
              'Origin': 'https://www.bilibili.com/'
          }

          # ä¸»ç«™ç­¾åˆ°
          def main_sign():
              logging.info("ğŸ” å¼€å§‹æ‰§è¡Œä¸»ç«™ç­¾åˆ°...")
              url = "https://api.bilibili.com/x/member/web/exp/reward"
              try:
                  resp = requests.get(url, headers=headers, timeout=10)
                  result = resp.json()
                  if result.get("code") == 0:
                      return f"âœ… ä¸»ç«™ç­¾åˆ°æˆåŠŸï¼{result.get('message','')}"
                  elif result.get("code") == 200013:
                      return "â„¹ï¸ ä¸»ç«™ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ— éœ€é‡å¤æ“ä½œ"
                  else:
                      return f"âš ï¸ ä¸»ç«™ç­¾åˆ°å¼‚å¸¸ï¼š{result.get('message','æœªçŸ¥é”™è¯¯')}"
              except Exception as e:
                  return f"âŒ ä¸»ç«™ç­¾åˆ°å¤±è´¥ï¼š{str(e)}"

          # ç›´æ’­ç­¾åˆ°
          def live_sign():
              logging.info("ğŸ” å¼€å§‹æ‰§è¡Œç›´æ’­ç­¾åˆ°...")
              url = "https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign"
              try:
                  resp = requests.get(url, headers=headers, timeout=10)
                  result = resp.json()
                  if result.get("code") == 0:
                      return f"âœ… ç›´æ’­ç­¾åˆ°æˆåŠŸï¼{result.get('msg','')}"
                  elif result.get("code") == 10003:
                      return "â„¹ï¸ ç›´æ’­ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ— éœ€é‡å¤æ“ä½œ"
                  else:
                      return f"âš ï¸ ç›´æ’­ç­¾åˆ°å¼‚å¸¸ï¼š{result.get('msg','æœªçŸ¥é”™è¯¯')}"
              except Exception as e:
                  return f"âŒ ç›´æ’­ç­¾åˆ°å¤±è´¥ï¼š{str(e)}"

          # æ‰§è¡Œç­¾åˆ°å¹¶æ±‡æ€»ç»“æœ
          if __name__ == "__main__":
              main_result = main_sign()
              live_result = live_sign()
              # æ±‡æ€»æ—¥å¿—å†…å®¹
              log_content = f"""ã€Bç«™è‡ªåŠ¨ç­¾åˆ°æ—¥å¿—ã€‘ â° æ‰§è¡Œæ—¶é—´ï¼š{beijing_time} {main_result} {live_result}"""
              # æ‰“å°æ—¥å¿—
              print(log_content)
              # è¾“å‡ºä¸ºActionå˜é‡ï¼ˆPythonæ­£ç¡®å†™æ³•ï¼Œä¿®å¤echoè¯¯å†™ï¼‰
              print(f"::set-output name=log_content::{log_content}")
          EOF
          
          # è¿è¡Œç­¾åˆ°è„šæœ¬
          python bilibili_sign.py

      # Barkæ¨é€iPhoneï¼ˆå®Œå…¨ä¿®å¤YAMLè¯­æ³•ï¼Œå•è¡Œå‘½ä»¤ï¼‰
      - name: Send Log to iPhone via Bark
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
          LOG_CONTENT: ${{ steps.sign_step.outputs.log_content }}
        run: |
          # Bashå†…ç½®URLç¼–ç å‡½æ•°
          urlencode() {
              local s="${1}"
              s="${s//'%'/'%25'}"
              s="${s//' '/'%20'}"
              s="${s//'!'/'%21'}"
              s="${s//'"'/'%22'}"
              s="${s//'#'/'%23'}"
              s="${s//'$'/'%24'}"
              s="${s//'&'/'%26'}"
              s="${s//"'"'/'%27'}"
              s="${s//'('/'%28'}"
              s="${s//')'/'%29'}"
              s="${s//'*'/'%2A'}"
              s="${s//'+'/'%2B'}"
              s="${s//','/'%2C'}"
              s="${s//'-'/'%2D'}"
              s="${s//'.'/'%2E'}"
              s="${s//'/'/'%2F'}"
              s="${s//':'/'%3A'}"
              s="${s//';'/'%3B'}"
              s="${s//'<'/'%3C'}"
              s="${s//'='/'%3D'}"
              s="${s//'>'/'%3E'}"
              s="${s//'?'/'%3F'}"
              s="${s//'@'/'%40'}"
              s="${s//'['/'%5B'}"
              s="${s//'\'/'%5C'}"
              s="${s//']'/'%5D'}"
              s="${s//'^'/'%5E'}"
              s="${s//'_'/'%5F'}"
              s="${s//'`'/'%60'}"
              s="${s//'{'/'%7B'}"
              s="${s//'|'/'%7C'}"
              s="${s//'}'/'%7D'}"
              s="${s//'~'/'%7E'}"
              echo "$s"
          }
          # ç¼–ç å¹¶æ¨é€
          ENCODED_CONTENT=$(urlencode "$LOG_CONTENT")
          curl -s "https://api.day.app/${BARK_KEY}/Bç«™ç­¾åˆ°æ—¥å¿—?body=${ENCODED_CONTENT}"
          echo "âœ… Barkæ¨é€è¯·æ±‚å·²å‘é€"
