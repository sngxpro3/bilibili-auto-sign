# 工作流名称（可自定义）
name: Bilibili Daily Auto Sign

# 触发条件：定时触发 + 手动触发（方便测试）
on:
  # 定时触发（UTC时间，对应北京时间每日0点）
  # GitHub Actions使用UTC时区，北京时间=UTC+8 → 0点=UTC16点
  schedule:
    - cron: '0 16 * * *'
  # 手动触发按钮（在Actions页面可见）
  workflow_dispatch:

# 执行的任务
jobs:
  bilibili-sign-job:
    # 运行环境：Ubuntu最新版（联网能力默认开启）
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出仓库代码（空仓库也需此步骤）
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 步骤2：配置Python环境（脚本基于Python编写）
      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # 稳定版本，兼容所有依赖

      # 步骤3：安装依赖（仅需requests库）
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 步骤4：执行签到脚本（核心步骤）
      - name: Run Bilibili Sign Script
        env:
          # 从Secrets中读取Cookie，避免明文泄露
          BILIBILI_COOKIE: ${{ secrets.BILIBILI_COOKIE }}
        run: |
          # 创建签到脚本文件
          cat > bilibili_sign.py << 'EOF'
          import requests
          import os
          import logging

          # 配置日志输出（便于排查问题）
          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s - %(levelname)s - %(message)s',
              datefmt='%Y-%m-%d %H:%M:%S'
          )

          # 从环境变量获取Cookie
          cookie = os.getenv('BILIBILI_COOKIE')
          if not cookie:
              logging.error("❌ 未获取到B站Cookie！请检查GitHub Secrets配置")
              exit(1)

          # 请求头（模拟浏览器，避免被风控）
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Cookie': cookie,
              'Referer': 'https://www.bilibili.com/',
              'Origin': 'https://www.bilibili.com/',
              'Accept-Language': 'zh-CN,zh;q=0.9'
          }

          # 1. 主站每日签到（2026年有效API）
          def main_sign():
              url = "https://api.bilibili.com/x/member/web/exp/reward"
              try:
                  resp = requests.get(url, headers=headers, timeout=15)
                  resp.raise_for_status()  # 抛出HTTP错误（如403/500）
                  result = resp.json()
                  if result.get("code") == 0:
                      logging.info("✅ 主站签到成功！" + result.get("message", ""))
                  elif result.get("code") == 200013:
                      logging.info("ℹ️ 今日已签到，无需重复操作")
                  else:
                      logging.warning("⚠️ 主站签到异常：" + result.get("message", "未知错误"))
              except Exception as e:
                  logging.error("❌ 主站签到失败：" + str(e))

          # 2. 直播区签到（额外获取经验，2026年有效API）
          def live_sign():
              url = "https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign"
              try:
                  resp = requests.get(url, headers=headers, timeout=15)
                  resp.raise_for_status()
                  result = resp.json()
                  if result.get("code") == 0:
                      logging.info("✅ 直播签到成功！" + result.get("msg", ""))
                  elif result.get("code") == 10003:
                      logging.info("ℹ️ 直播今日已签到")
                  else:
                      logging.warning("⚠️ 直播签到异常：" + result.get("msg", "未知错误"))
              except Exception as e:
                  logging.error("❌ 直播签到失败：" + str(e))

          # 执行签到
          if __name__ == "__main__":
              logging.info("===== 开始B站自动签到 =====")
              main_sign()
              live_sign()
              logging.info("===== 签到流程执行完毕 =====")
          EOF
          
          # 运行签到脚本
          python bilibili_sign.py
