name: Bilibili Daily Auto Sign

on:
  schedule:
    - cron: '0 16 * * *'  # UTC16ç‚¹=åŒ—äº¬æ—¶é—´0ç‚¹
  workflow_dispatch:

jobs:
  bilibili-sign-job:
    runs-on: ubuntu-latest
    steps:
      - name: Set Timezone to Beijing
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "âœ… æ—¶åŒºå·²è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´ï¼Œå½“å‰æ—¶é—´ï¼š$(date)"  # å¼ºåˆ¶è¾“å‡º

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          echo "ðŸ”§ å¼€å§‹å®‰è£…ä¾èµ–..."
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          pip install requests pytz -i https://pypi.tuna.tsinghua.edu.cn/simple
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run Bilibili Sign Script
        env:
          BILIBILI_COOKIE: ${{ secrets.BILIBILI_COOKIE }}
        run: |
          echo "ðŸ”§ å¼€å§‹åˆ›å»ºç­¾åˆ°è„šæœ¬..."
          # åˆ›å»ºå¸¦å¼ºåˆ¶è°ƒè¯•è¾“å‡ºçš„è„šæœ¬
          cat > bilibili_sign.py << 'EOF'
          import requests
          import os
          import logging
          from datetime import datetime
          import pytz

          # å¼ºåˆ¶è¾“å‡ºæ—¥å¿—åˆ°æŽ§åˆ¶å°ï¼ˆç¡®ä¿èƒ½çœ‹åˆ°ï¼‰
          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s - %(levelname)s - %(message)s',
              datefmt='%Y-%m-%d %H:%M:%S',
              handlers=[logging.StreamHandler()]  # å¼ºåˆ¶è¾“å‡ºåˆ°æŽ§åˆ¶å°
          )

          # ç¬¬ä¸€æ­¥ï¼šæ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œç¡®è®¤çŽ¯å¢ƒå˜é‡
          print("\n===== è°ƒè¯•ä¿¡æ¯ =====")
          cookie = os.getenv('BILIBILI_COOKIE')
          print(f"Cookieæ˜¯å¦è¯»å–åˆ°ï¼š{'æ˜¯' if cookie else 'å¦'}")
          print(f"Cookieé•¿åº¦ï¼š{len(cookie) if cookie else 0}")
          print("====================\n")

          if not cookie:
              logging.error("âŒ æœªèŽ·å–åˆ°Bç«™Cookieï¼è¯·æ£€æŸ¥GitHub Secretsé…ç½®")
              exit(1)

          # é…ç½®è¯·æ±‚å¤´
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Cookie': cookie,
              'Referer': 'https://www.bilibili.com/',
              'Origin': 'https://www.bilibili.com/',
              'Accept-Language': 'zh-CN,zh;q=0.9'
          }

          # ä¸»ç«™ç­¾åˆ°ï¼ˆå¸¦è¯¦ç»†è°ƒè¯•ï¼‰
          def main_sign():
              logging.info("ðŸ” å¼€å§‹æ‰§è¡Œä¸»ç«™ç­¾åˆ°...")
              url = "https://api.bilibili.com/x/member/web/exp/reward"
              try:
                  resp = requests.get(url, headers=headers, timeout=10)
                  print(f"ðŸ“Œ ä¸»ç«™APIå“åº”çŠ¶æ€ç ï¼š{resp.status_code}")
                  print(f"ðŸ“Œ ä¸»ç«™APIå“åº”å†…å®¹ï¼š{resp.text}")
                  resp.raise_for_status()
                  result = resp.json()
                  if result.get("code") == 0:
                      logging.info("âœ… ä¸»ç«™ç­¾åˆ°æˆåŠŸï¼" + result.get("message", ""))
                  elif result.get("code") == 200013:
                      logging.info("â„¹ï¸ ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ— éœ€é‡å¤æ“ä½œ")
                  else:
                      logging.warning("âš ï¸ ä¸»ç«™ç­¾åˆ°å¼‚å¸¸ï¼š" + result.get("message", "æœªçŸ¥é”™è¯¯"))
              except requests.exceptions.Timeout:
                  logging.error("âŒ ä¸»ç«™ç­¾åˆ°è¶…æ—¶ï¼ˆç½‘ç»œé—®é¢˜ï¼‰")
              except requests.exceptions.ConnectionError:
                  logging.error("âŒ ä¸»ç«™ç­¾åˆ°è¿žæŽ¥å¤±è´¥ï¼ˆBç«™APIä¸å¯è¾¾ï¼‰")
              except Exception as e:
                  logging.error(f"âŒ ä¸»ç«™ç­¾åˆ°å¤±è´¥ï¼š{str(e)}")

          # ç›´æ’­ç­¾åˆ°ï¼ˆå¸¦è¯¦ç»†è°ƒè¯•ï¼‰
          def live_sign():
              logging.info("ðŸ” å¼€å§‹æ‰§è¡Œç›´æ’­ç­¾åˆ°...")
              url = "https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign"
              try:
                  resp = requests.get(url, headers=headers, timeout=10)
                  print(f"ðŸ“Œ ç›´æ’­APIå“åº”çŠ¶æ€ç ï¼š{resp.status_code}")
                  print(f"ðŸ“Œ ç›´æ’­APIå“åº”å†…å®¹ï¼š{resp.text}")
                  resp.raise_for_status()
                  result = resp.json()
                  if result.get("code") == 0:
                      logging.info("âœ… ç›´æ’­ç­¾åˆ°æˆåŠŸï¼" + result.get("msg", ""))
                  elif result.get("code") == 10003:
                      logging.info("â„¹ï¸ ç›´æ’­ä»Šæ—¥å·²ç­¾åˆ°")
                  else:
                      logging.warning("âš ï¸ ç›´æ’­ç­¾åˆ°å¼‚å¸¸ï¼š" + result.get("msg", "æœªçŸ¥é”™è¯¯"))
              except requests.exceptions.Timeout:
                  logging.error("âŒ ç›´æ’­ç­¾åˆ°è¶…æ—¶ï¼ˆç½‘ç»œé—®é¢˜ï¼‰")
              except requests.exceptions.ConnectionError:
                  logging.error("âŒ ç›´æ’­ç­¾åˆ°è¿žæŽ¥å¤±è´¥ï¼ˆBç«™APIä¸å¯è¾¾ï¼‰")
              except Exception as e:
                  logging.error(f"âŒ ç›´æ’­ç­¾åˆ°å¤±è´¥ï¼š{str(e)}")

          # æ‰§è¡Œä¸»é€»è¾‘
          if __name__ == "__main__":
              beijing_tz = pytz.timezone('Asia/Shanghai')
              beijing_time = datetime.now(beijing_tz)
              logging.info(f"===== å¼€å§‹Bç«™è‡ªåŠ¨ç­¾åˆ°ï¼ˆåŒ—äº¬æ—¶é—´ï¼š{beijing_time.strftime('%Y-%m-%d %H:%M:%S')}ï¼‰=====")
              main_sign()
              live_sign()
              logging.info("===== ç­¾åˆ°æµç¨‹æ‰§è¡Œå®Œæ¯• =====")
          EOF
          
          echo "ðŸ”§ å¼€å§‹è¿è¡Œç­¾åˆ°è„šæœ¬..."
          python bilibili_sign.py
          echo "ðŸ”§ è„šæœ¬è¿è¡Œç»“æŸ"
