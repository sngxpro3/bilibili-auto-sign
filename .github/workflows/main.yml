name: Bilibili Daily Auto Sign

on:
  schedule:
    - cron: '0 16 * * *'  # UTC16ç‚¹=åŒ—äº¬æ—¶é—´0ç‚¹ï¼Œå¯è‡ªè¡Œä¿®æ”¹
  workflow_dispatch:

jobs:
  bilibili-sign-job:
    runs-on: ubuntu-latest
    steps:
      - name: Set Timezone to Beijing
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "âœ… æ—¶åŒºå·²è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´ï¼Œå½“å‰æ—¶é—´ï¼š$(date)"

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          pip install requests pytz -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: Run Bilibili Sign Script
        id: sign_step  # ç»™æ­¥éª¤åŠ IDï¼Œç”¨äºŽåŽç»­è¯»å–æ—¥å¿—
        env:
          BILIBILI_COOKIE: ${{ secrets.BILIBILI_COOKIE }}
        run: |
          # åˆ›å»ºç­¾åˆ°è„šæœ¬
          cat > bilibili_sign.py << 'EOF'
          import requests
          import os
          import logging
          from datetime import datetime
          import pytz

          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s - %(levelname)s - %(message)s',
              datefmt='%Y-%m-%d %H:%M:%S',
              handlers=[logging.StreamHandler()]
          )

          # èŽ·å–åŒ—äº¬æ—¶é—´
          beijing_tz = pytz.timezone('Asia/Shanghai')
          beijing_time = datetime.now(beijing_tz).strftime('%Y-%m-%d %H:%M:%S')

          # è¯»å–Cookie
          cookie = os.getenv('BILIBILI_COOKIE')
          if not cookie:
              logging.error("âŒ æœªèŽ·å–åˆ°Bç«™Cookieï¼è¯·æ£€æŸ¥GitHub Secretsé…ç½®")
              exit(1)

          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Cookie': cookie,
              'Referer': 'https://www.bilibili.com/',
              'Origin': 'https://www.bilibili.com/'
          }

          # ä¸»ç«™ç­¾åˆ°
          def main_sign():
              logging.info("ðŸ” å¼€å§‹æ‰§è¡Œä¸»ç«™ç­¾åˆ°...")
              url = "https://api.bilibili.com/x/member/web/exp/reward"
              try:
                  resp = requests.get(url, headers=headers, timeout=10)
                  result = resp.json()
                  if result.get("code") == 0:
                      return f"âœ… ä¸»ç«™ç­¾åˆ°æˆåŠŸï¼{result.get('message','')}"
                  elif result.get("code") == 200013:
                      return "â„¹ï¸ ä¸»ç«™ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ— éœ€é‡å¤æ“ä½œ"
                  else:
                      return f"âš ï¸ ä¸»ç«™ç­¾åˆ°å¼‚å¸¸ï¼š{result.get('message','æœªçŸ¥é”™è¯¯')}"
              except Exception as e:
                  return f"âŒ ä¸»ç«™ç­¾åˆ°å¤±è´¥ï¼š{str(e)}"

          # ç›´æ’­ç­¾åˆ°
          def live_sign():
              logging.info("ðŸ” å¼€å§‹æ‰§è¡Œç›´æ’­ç­¾åˆ°...")
              url = "https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign"
              try:
                  resp = requests.get(url, headers=headers, timeout=10)
                  result = resp.json()
                  if result.get("code") == 0:
                      return f"âœ… ç›´æ’­ç­¾åˆ°æˆåŠŸï¼{result.get('msg','')}"
                  elif result.get("code") == 10003:
                      return "â„¹ï¸ ç›´æ’­ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ— éœ€é‡å¤æ“ä½œ"
                  else:
                      return f"âš ï¸ ç›´æ’­ç­¾åˆ°å¼‚å¸¸ï¼š{result.get('msg','æœªçŸ¥é”™è¯¯')}"
              except Exception as e:
                  return f"âŒ ç›´æ’­ç­¾åˆ°å¤±è´¥ï¼š{str(e)}"

          # æ‰§è¡Œç­¾åˆ°å¹¶æ±‡æ€»ç»“æžœ
          if __name__ == "__main__":
              main_result = main_sign()
              live_result = live_sign()
              # æ±‡æ€»æ—¥å¿—å†…å®¹ï¼ˆç”¨äºŽæŽ¨é€ï¼Œæ›¿æ¢æ¢è¡Œç¬¦é¿å…YAMLé”™è¯¯ï¼‰
              log_content = f"""ã€Bç«™è‡ªåŠ¨ç­¾åˆ°æ—¥å¿—ã€‘
â° æ‰§è¡Œæ—¶é—´ï¼š{beijing_time}
{main_result}
{live_result}"""
              # æ›¿æ¢æ¢è¡Œç¬¦ä¸ºç©ºæ ¼ï¼ˆé¿å…æŽ¨é€æ—¶æ ¼å¼é”™è¯¯ï¼‰
              log_content = log_content.replace('\n', ' ')
              # æ‰“å°æ—¥å¿—åˆ°æŽ§åˆ¶å°
              print(log_content)
              # å°†æ—¥å¿—è¾“å‡ºä¸ºActionå˜é‡ï¼ˆè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼‰
              echo "::set-output name=log_content::${log_content//'%'/'%25'}"
          EOF
          
          # è¿è¡Œç­¾åˆ°è„šæœ¬
          python bilibili_sign.py

      # ðŸ‘‡ BarkæŽ¨é€iPhoneï¼ˆä¿®å¤YAMLè¯­æ³•+ç§»é™¤jqä¾èµ–ï¼‰
      - name: Send Log to iPhone via Bark
        env:
          BARK_KEY: ${{ secrets.BARK_KEY }}
          LOG_CONTENT: ${{ steps.sign_step.outputs.log_content }}
        run: |
          # æ‰‹åŠ¨URLç¼–ç ï¼ˆæ— éœ€jqï¼Œçº¯bashå®žçŽ°ï¼‰
          urlencode() {
              local string="${1}"
              local strlen=${#string}
              local encoded=""
              for (( pos=0 ; pos<strlen ; pos++ )); do
                  c=${string:$pos:1}
                  case "$c" in
                      [-_.~a-zA-Z0-9] ) encoded="$encoded$c" ;;
                      * ) printf -v encoded "$encoded%%%02X" "'$c" ;;
                  esac
              done
              echo "$encoded"
          }
          # ç¼–ç æ—¥å¿—å†…å®¹
          ENCODED_CONTENT=$(urlencode "$LOG_CONTENT")
          # å‘é€BarkæŽ¨é€ï¼ˆå•è¡Œå‘½ä»¤ï¼Œé¿å…YAMLæ¢è¡Œé”™è¯¯ï¼‰
          curl -s -X GET "https://api.day.app/${BARK_KEY}/Bç«™ç­¾åˆ°æ—¥å¿—?body=${ENCODED_CONTENT}"
          echo "âœ… BarkæŽ¨é€è¯·æ±‚å·²å‘é€"

          # ðŸ‘‡ Serveré…±æŽ¨å¾®ä¿¡ï¼ˆä¿®å¤è¯­æ³•é”™è¯¯ç‰ˆï¼‰
- name: Send Log to WeChat via ServerChan
  env:
    SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
    LOG_CONTENT: ${{ steps.sign_step.outputs.log_content }}
  run: |
    # å•è¡Œcurlå‘½ä»¤ï¼Œé¿å…YAMLè¯­æ³•é”™è¯¯
    curl -s -X POST "https://sctapi.ftqq.com/${SENDKEY}.send" -d "title=Bç«™ç­¾åˆ°æ—¥å¿—" -d "desp=${LOG_CONTENT}"
    echo "âœ… Serveré…±æŽ¨é€è¯·æ±‚å·²å‘é€"
